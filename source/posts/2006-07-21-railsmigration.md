---
title: RailsのMigration
date: 2006-07-21 14:53:17
authors: akahige
tags: ruby, resume, 
---
<h3><a name="l0"></a> なんですかこれは</h3>
データベース構造をバージョン管理する仕組み

SQLではなくRubyのコードでデータベース構造を記述することによって抽象化
<ul>
	<li>本番環境への変更の適用漏れがなくなる</li>
	<li>ほかの開発環境や検証環境への変更の適用がバッチリ</li>
	<li>必要があれば以前のバージョンに戻せる</li>
	<li>複数のデータベースエンジンへの対応が簡単にできる
<ul>
	<li>MySQL, PostgreSQL, SQLite, SQL Server, Sybase, Oracle (メジャーなものはDB2以外ぜんぶだって)</li>
</ul>
</li>
</ul>
<!--more-->
<h3><a name="l1"></a> どうつかいますか</h3>
<pre><code>$ svn up
$ rake migrate</code></pre>
セットで使う。

これで手元の開発環境のソースコードとデータベースの構造が最新のものになる。
<h3><a name="l2"></a> 仕組み</h3>
schema_infoというテーブルとMigration定義ファイルの名前でバージョン管理
<h3><a name="l3"></a> Migration関連の操作</h3>
<h4><a name="l4"></a> rake db:schema:dump (rake db_schema_dump)</h4>
db/schema.rbにデータベース構造をダンプする。
<pre><code># This file is autogenerated. Instead of editing this file, please use the
# migrations feature of ActiveRecord to incrementally modify your database, and
# then regenerate this schema definition.</code></pre>
ダンプされたファイルの最初の三行。
このファイルを編集して使うんじゃなくてMigrationを使ってくれと言っている。

既存のデータベースがあって途中からMigrationをはじめる場合はこのファイルを元に最初の定義ファイルを作っていくと良い。

このときunsignedなど抽象表現でサポートしてない構造は消えてしまうので注意。
<h4><a name="l5"></a> rake db:schema:load (rake db_schema_import)</h4>
db/schema.rbの内容をデータベースに反映する。

普通は使わない？
<h4><a name="l6"></a> ./script/generate migration MigrationName</h4>
Migration定義ファイルの雛形を作成する。
<pre><code>class Hoge &lt; ActiveRecord::Migration
def self.up
end

def self.down
end
end</code></pre>
<h4><a name="l7"></a> rake migrate</h4>
Migration定義ファイルの内容をすべて開発用のデータベースに反映する。
<h4><a name="l8"></a> rake migrate VERSION=1</h4>
Migration定義ファイルの内容に従ってデータベースの構造を指定されたバージョンの状態に戻す

※バージョンを戻す場合はsvnより先にmigrate（定義ファイルがなくなると元に戻せない）
<h4><a name="l9"></a> rake migrate RAILS_ENV=production</h4>
本番環境へのMigration
<h3><a name="l10"></a> Migration定義ファイルの書き方</h3>
<h4><a name="l11"></a> ファイル名とバージョン</h4>
ファイル名の先頭にバージョン番号を入れる
<pre><code>001_create_gadgets.rb
002_migration_test.rb</code></pre>
ファイル名とクラス名はそろえないとダメ

ファイル名のバージョン番号は現在あるファイルをもとに作られるので、複数人で開発してるとバッティングしてしまうこともあり得る
そういう場合はバージョン戻したりして適宜調整。
<h4><a name="l12"></a> self.upとself.down</h4>
バージョンを進めるときにself.upが実行されて、バージョンを戻すときにself.downが実行される。

この整合性が取れてないとバージョンを戻したときにおかしなことになる可能性がある。
<h4><a name="l13"></a> できること一覧</h4>
<ul>
	<li>create_table(name, options)</li>
	<li>drop_table(name)</li>
	<li>rename_table(old_name, new_name)</li>
	<li>add_column(table_name, column_name, type, options)</li>
	<li>rename_column(table_name, column_name, new_column_name)</li>
	<li>change_column(table_name, column_name, type, options)</li>
	<li>remove_column(table_name, column_name)</li>
	<li>add_index(table_name, column_name, index_type)</li>
	<li>remove_index(table_name, column_name)</li>
</ul>
<h4><a name="l14"></a> カラムの型</h4>
<table border="1">
<tr>
<td>抽象表現</td>
<td>Ruby型</td>
<td>PostgreSQL型</td>
<td>MySQL型</td>
</tr>
<tr>
<td>:primary_key</td>
<td>Fixnum</td>
<td>serial</td>
<td>primary key	int(11) DEFAULT NULL auto_increment PRIMARY KEY</td>
</tr>
<tr>
<td>:string</td>
<td>String</td>
<td>character varying(255)</td>
<td>varchar(255)</td>
</tr>
<tr>
<td>:text</td>
<td>String</td>
<td>text</td>
<td>text</td>
</tr>
<tr>
<td>:integer</td>
<td>Fixnum</td>
<td>integer</td>
<td>int(11)</td>
</tr>
<tr>
<td>:float</td>
<td>Float</td>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td>:datetime</td>
<td>Time</td>
<td>timestamp</td>
<td>datetime</td>
</tr>
<tr>
<td>:timestamp</td>
<td>Time</td>
<td>timestamp</td>
<td>datetime</td>
</tr>
<tr>
<td>:time</td>
<td>Time</td>
<td>timestamp</td>
<td>datetime</td>
</tr>
<tr>
<td>:date</td>
<td>Date</td>
<td>date</td>
<td>date</td>
</tr>
<tr>
<td>:binary</td>
<td>String</td>
<td>bytea</td>
<td>blob</td>
</tr>
<tr>
<td>:boolean</td>
<td>Object</td>
<td>boolean</td>
<td>tinyint(1)</td>
</tr>
</table>
<ul>
	<li>MySQLの数値型
<ul>
	<li>:integer, :limit =&gt; 3 → tinyint</li>
	<li>:integer, :limit =&gt; 5 → smallint</li>
	<li>:integer, :limit =&gt; 7 → mediumint</li>
	<li>:integer, :limit =&gt; 10 → int</li>
	<li>:integer, :limit =&gt; 20 → bigint</li>
</ul>
</li>
</ul>
unsignedにはできないぽい？

BLOB型とかも桁数指定でtinyblobとかになります。
<h4><a name="l15"></a> カラムのオプション</h4>
<table border="1">
<tr>
<td>:limit</td>
<td>数値で桁数指定</td>
</tr>
<tr>
<td>:default</td>
<td>デフォルト値を指定</td>
</tr>
<tr>
<td>:null</td>
<td>true or false</td>
</tr>
</table>
<h4><a name="l16"></a> 生SQLも</h4>
<ul>
	<li>execute(sql)</li>
</ul>
どうしてもunsignedつけたいときとか。
<h4><a name="l17"></a> スキーマ変更以外のデータメンテにも</h4>
どうぞ
<h3><a name="l18"></a> 参考にしたページ</h3>
<ul>
	<li><a href="http://wota.jp/ac/?date=20050817#p01">ヽ( ・∀・)ノくまくまー(2005-08-17) Migration </a></li>
	<li><a href="http://api.rails2u.com/docs/activerecord/classes/ActiveRecord/Migration.html#M000358">Class: ActiveRecord::Migration:</a></li>
	<li><a href="http://wiki.rubyonrails.org/rails/pages/UsingMigrations">UsingMigrations in Ruby on Rails</a></li>
	<li><a href="http://garrettsnider.backpackit.com/pub/367902">Rails Migration Cheat Sheet </a></li>
</ul>
<div>
<h2><a name="l19"></a> おまけトピックス</h2>
<div>
<div>
<h3><a name="l20"></a> 本番運用</h3>
なめてると意外と難しい
<h4><a name="l21"></a> httpd</h4>
<ul>
	<li>Apache+Fast-CGI
<ul>
	<li>設定かなりめんどい</li>
	<li>2.0だと不安定</li>
	<li>とはいえApacheで動かさざるを得ない場合は多い</li>
</ul>
</li>
	<li>lighttpd+Fast-CGI
<ul>
	<li>設定それなりにめんどい</li>
	<li>事実上Railsの標準？</li>
</ul>
</li>
	<li>mongrel
<ul>
	<li>簡単ではやい（らしい）</li>
	<li>台頭中</li>
</ul>
</li>
	<li>WEBrick
<ul>
	<li>簡単だしパフォーマンスもそこそこ</li>
	<li>アクセスが少なければコレで十分</li>
</ul>
</li>
	<li>Apache+CGI
<ul>
	<li>ナローバンドの時代に逆戻りしたかのような懐かしさを覚える</li>
	<li>ダメ、絶対</li>
</ul>
</li>
</ul>
<h4><a name="l22"></a> データベース</h4>
<ul>
	<li>development,test,productionの環境の違いに注意</li>
	<li>database.ymlはリポジトリに入れるべきなんだろうか</li>
	<li>多少の学習コストを払ってもMigrationを使ったほうがいい</li>
</ul>
<h4><a name="l23"></a> Railsバージョン互換性問題</h4>
Railsのバージョンが変わるとアプリが動かなくなる。
freezeしとくとvender以下に特定バージョンのRailsを置いておけるので平気。
<ul>
	<li>rake rails:freeze:gems - 現在インストールされてるバージョンを使用。普段はたぶんこれ。</li>
	<li>rake rails:freeze:edge - RailsリポジトリのHEADを持ってくる。たぶん実験とかするときに使う。</li>
	<li>rake rails:freeze:edge TAG=rel_1-1-2 - Railsのリポジトリから指定タグのバージョンを持ってくる</li>
</ul>
<h4><a name="l24"></a> Capistrano</h4>
<ul>
	<li>古いディストリだとrubyのopensslのライブラリが鬼門な気がする</li>
	<li>database.ymlリポジトリからいつも持ってくる</li>
	<li>すべてのサーバにRubyとrakeとrailsを入れないとダメでユーザも作らないとダメなのがめんどい</li>
	<li>けどRailsアプリをスケールアウトするならコレ</li>
</ul>
<h3><a name="l25"></a> 開発環境どうする</h3>
<ul>
	<li>ローカルで編集してアップ
<ul>
	<li>scp</li>
	<li>rsync</li>
</ul>
</li>
	<li>リモートのファイルを直接編集
<ul>
	<li>エディタのリモートファイル編集機能</li>
	<li>samba</li>
</ul>
</li>
	<li>そもそもLinuxマシンをクライアントに</li>
	<li>WindowsにRailsを入れる
<ul>
	<li>Cygwin上に入れたものはほぼ問題なく動くようだ</li>
	<li>ローカル開発万歳</li>
</ul>
</li>
	<li>Mac Bookを買う</li>
</ul>
</div>
</div>
</div>